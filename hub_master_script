/**
 * INFOTRUST PORTAL - MASTER SCRIPT
 * Contains logic for:
 * 1. Global Utilities (Accessibility, Share)
 * 2. API Connectors (Locked Assets, Feedback)
 * 3. Newsletter Archive (SPA, Filtering, Load More)
 * 4. Interactive Elements (Quizzes, Accordions, FAQs)
 * 5. Homepage Widgets (Time, Tracker)
 */

// ==========================================
// 1. GLOBAL UTILITIES
// ==========================================

// Toggle High Contrast Mode
window.toggleAccessibility = function() {
    document.body.classList.toggle('accessibility-mode');
    // Toggle active state for any button that triggered this
    const btns = document.querySelectorAll('.util-btn[onclick*="toggleAccessibility"]');
    btns.forEach(btn => btn.classList.toggle('active'));
};

// Copy Current URL to Clipboard
window.copyToClipboard = function() {
    // Fallback for older browsers or non-secure contexts
    const dummy = document.createElement('input');
    document.body.appendChild(dummy);
    dummy.value = window.location.href;
    dummy.select();
    document.execCommand('copy');
    document.body.removeChild(dummy);
    
    // Visual Feedback
    const shareBtns = document.querySelectorAll('.share-trigger');
    shareBtns.forEach(btn => {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = 'Copied <i class="fa-solid fa-check"></i>';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
        }, 2000);
    });
};


// ==========================================
// 2. API CONNECTORS (LOCKED PAGES & FORMS)
// ==========================================

// Interest Capture (Locked Cards)
// Usage: <button onclick="captureInterest(this, 'Asset Name')">
window.captureInterest = function(btnElement, deliverableName) {
    // UI State: Loading
    const originalText = btnElement.innerHTML;
    btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
    btnElement.disabled = true;

    // Gather Context
    const userEmail = window.analyticsUserEmail || "unknown@user.com"; 
    const timestamp = new Date().toISOString();

    const payload = {
        email: userEmail,
        domain: window.location.hostname,
        path: window.location.pathname,
        date: timestamp,
        deliverable: deliverableName
    };

    // Google Apps Script Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3QwMuUpiPeRKEtV_wi2RvMGWTqffS8qe6M0iI7VbiXUrnn5pPez-QTIbexztbKsbR/exec"; 

    // Send Request
    fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(() => {
        btnElement.classList.add('sent');
        btnElement.innerHTML = '<i class="fa-solid fa-check"></i> Request Sent';
    })
    .catch(error => {
        console.error("Error logging interest:", error);
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
        alert("There was a slight issue sending your request. Please contact your account manager.");
    });
};

// Feedback Form Submission
// Usage: <form onsubmit="window.submitFeedback(event)">
window.submitFeedback = function(e) {
    e.preventDefault();
    
    const ratingInput = document.getElementById('ratingSlider');
    const notesInput = document.getElementById('feedbackNotes');
    
    // Guard clause if elements don't exist
    if(!ratingInput) return;

    const rating = ratingInput.value;
    const notes = notesInput ? notesInput.value : "";
    const pageUrl = window.location.href;
    const timestamp = new Date().toISOString();
    
    // Reuse the same script URL or a specific one for feedback
    const FEEDBACK_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeHVZiDONjwbGlzgXSdTWYCNvZ0CiOhkV-9SAh2Jl5wzVxfA4rlb5RwYjSU8TUibzp/exec"; 
    
    const data = { timestamp: timestamp, url: pageUrl, rating: rating, feedback: notes };

    const submitBtn = e.target.querySelector('button');
    const originalText = submitBtn.innerText;
    submitBtn.innerText = "Sending...";
    submitBtn.disabled = true;

    fetch(FEEDBACK_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(() => {
        const form = document.getElementById('feedbackForm');
        const msg = document.getElementById('feedbackMessage');
        if(form) form.style.display = 'none';
        if(msg) msg.style.display = 'block';
    })
    .catch(err => {
        console.error('Error:', err);
        alert("Error sending feedback.");
        submitBtn.innerText = originalText;
        submitBtn.disabled = false;
    });
};

// Slider Display Update
window.updateRatingDisplay = function(val) {
    const display = document.getElementById('ratingValue');
    if(display) display.innerText = val + "/5";
};


// ==========================================
// 3. NEWSLETTER ARCHIVE LOGIC
// ==========================================

// Variables for Load More
const BATCH_SIZE = 4; 
let visibleCount = BATCH_SIZE;

// Visibility Logic (The Curtain)
window.updateVisibility = function() {
    const grid = document.getElementById('news-container');
    if (!grid) return; // Exit if not on archive page

    const items = Array.from(grid.children);
    const loadMoreBtnContainer = document.querySelector('.load-more-container');
    
    // Check Search/Filter State
    const searchInput = document.getElementById('search-input');
    const topicFilter = document.getElementById('filter-topic');
    
    let isFiltering = false;
    if(searchInput && topicFilter) {
         isFiltering = (searchInput.value.length > 0 || topicFilter.value !== 'All');
    }

    if(isFiltering) {
        if(loadMoreBtnContainer) loadMoreBtnContainer.style.display = 'none';
        return;
    }

    // Standard Load More Logic
    let hiddenCount = 0;
    items.forEach((item, index) => {
        // Force flex if visible, none if hidden
        if(index < visibleCount) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
            hiddenCount++;
        }
    });

    // Toggle Button
    if(loadMoreBtnContainer) {
        loadMoreBtnContainer.style.display = (hiddenCount > 0) ? 'flex' : 'none';
    }
};

// Load More Click Action
window.loadMoreItems = function() {
    visibleCount += 3;
    window.updateVisibility();
};

// SPA View Switcher (List <-> Article)
window.switchView = function(viewId) {
    // Hide all views
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('it-hidden'));
    
    const target = document.getElementById(viewId);
    if(target) target.classList.remove('it-hidden');
    
    // Handle Nav Visibility (Swap Pills vs Back Button)
    const archiveNav = document.getElementById('archive-nav');
    const articleNav = document.getElementById('article-nav');

    if(viewId === 'view-archive') {
        if(archiveNav) archiveNav.classList.remove('it-hidden');
        if(articleNav) articleNav.classList.add('it-hidden');
        // Clear Hash
        history.pushState("", document.title, window.location.pathname + window.location.search);
    } else {
        if(archiveNav) archiveNav.classList.add('it-hidden');
        if(articleNav) articleNav.classList.remove('it-hidden');
        // Set Hash
        window.location.hash = viewId;
    }
    window.scrollTo(0,0);
};

// Filter Logic
window.filterNews = function() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const topic = document.getElementById('filter-topic').value;
    const items = document.querySelectorAll('.news-item');
    
    items.forEach(item => {
        const text = item.innerText.toLowerCase();
        const tags = item.getAttribute('data-tags').toLowerCase();
        const matchSearch = text.includes(search);
        const matchTopic = (topic === 'All') || tags.includes(topic.toLowerCase());
        
        if(matchSearch && matchTopic) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
    // Re-check pagination
    window.updateVisibility();
};

// Sort Logic
window.sortNews = function() {
    const order = document.getElementById('sort-order').value;
    const grid = document.getElementById('news-container');
    if(!grid) return;

    const items = Array.from(grid.children);
    
    items.sort((a, b) => {
        const dateA = new Date(a.getAttribute('data-date'));
        const dateB = new Date(b.getAttribute('data-date'));
        return (order === 'newest') ? dateB - dateA : dateA - dateB;
    });
    
    items.forEach(item => grid.appendChild(item));
    
    // Reset view to top
    visibleCount = BATCH_SIZE;
    window.updateVisibility();
};


// ==========================================
// 4. INTERACTIVE ELEMENTS (QUIZ, ACCORDION, FAQ)
// ==========================================

// Accordion & FAQ (Same Logic)
window.toggleAccordion = window.toggleFaq = function(header) {
    header.classList.toggle('active');
    var content = header.nextElementSibling;
    
    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        content.classList.remove('open'); // For CSS styling if needed
    } else {
        content.classList.add('open');
        content.style.maxHeight = content.scrollHeight + "px";
    }
};

// Quiz Logic
let quizScore = 0;

window.startQuiz = function() {
    const intro = document.getElementById('quiz-intro');
    const q1 = document.getElementById('q1');
    const progress = document.getElementById('quiz-progress');
    
    if(intro) intro.classList.remove('active');
    if(q1) q1.classList.add('active');
    if(progress) {
        progress.style.display = 'flex';
        progress.querySelector('span').innerText = 'Question 1 of 3';
    }
    quizScore = 0;
};

window.checkAnswer = function(btn, isCorrect, stepId) {
    const parent = document.getElementById(stepId);
    const buttons = parent.querySelectorAll('.quiz-option-btn');
    buttons.forEach(b => b.disabled = true);

    const feedbackEl = document.getElementById('feedback-' + stepId);
    if (isCorrect) {
        btn.classList.add('correct');
        feedbackEl.innerHTML = '<span style="color:#2ECC71"><i class="fa-solid fa-check"></i> Correct!</span>';
        quizScore++;
    } else {
        btn.classList.add('incorrect');
        feedbackEl.innerHTML = '<span style="color:#E74C3C"><i class="fa-solid fa-xmark"></i> Incorrect.</span>';
    }

    // Auto-advance
    setTimeout(() => {
        parent.classList.remove('active');
        let nextStepId = '';
        let nextStepNum = 0;

        if(stepId === 'q1') { nextStepId = 'q2'; nextStepNum = 2; }
        else if(stepId === 'q2') { nextStepId = 'q3'; nextStepNum = 3; }
        else if(stepId === 'q3') { nextStepId = 'quiz-results'; nextStepNum = 0; }

        const nextEl = document.getElementById(nextStepId);
        if(nextEl) nextEl.classList.add('active');
        
        const progressEl = document.getElementById('quiz-progress');
        if(progressEl) {
             if(nextStepNum > 0) {
                 progressEl.querySelector('span').innerText = 'Question ' + nextStepNum + ' of 3';
             } else {
                 progressEl.style.display = 'none';
             }
        }

        if(nextStepId === 'quiz-results') {
            document.getElementById('final-score').innerText = quizScore;
        }

    }, 1500);
};


// ==========================================
// 5. HOMEPAGE SPECIFICS & INITIALIZATION
// ==========================================

// Homepage Date/Time
function updateDateTime() {
    const dateEl = document.getElementById('current-date');
    const timeEl = document.getElementById('current-time');
    
    if(!dateEl || !timeEl) return;

    const now = new Date();
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
    
    dateEl.textContent = now.toLocaleDateString('en-US', dateOptions);
    timeEl.textContent = now.toLocaleTimeString('en-US', timeOptions);
}

// Homepage Tracker Switcher
window.updateTracker = function(url) {
    const iframe = document.getElementById('tracker-frame');
    if(iframe) iframe.src = url;
};


// ==========================================
// MASTER INITIALIZATION
// ==========================================
document.addEventListener("DOMContentLoaded", function() {
    
    // 1. Run Hash Check for Archive (React Hydration Fix)
    var pollCount = 0;
    var hashCheck = setInterval(function() {
        pollCount++;
        if(window.location.hash) {
            var targetId = window.location.hash.substring(1);
            var targetElement = document.getElementById(targetId);
            if(targetElement) {
                // If found and hidden, force switch
                if(targetElement.classList.contains('it-hidden')) {
                    if(typeof window.switchView === 'function') {
                        window.switchView(targetId);
                    }
                }
            }
        }
        if(pollCount > 20) clearInterval(hashCheck);
    }, 100);

    // 2. Initialize Newsletter Visibility
    if(typeof window.updateVisibility === 'function') {
        window.updateVisibility();
    }

    // 3. Start Clock if on Homepage
    if(document.getElementById('current-date')) {
        updateDateTime();
        setInterval(updateDateTime, 1000);
    }
    
    // 4. Auto-Hide Empty Elements (Education Hub Helper)
    const autoHideElements = document.querySelectorAll('.auto-hide');
    autoHideElements.forEach(el => {
        if (el.innerText.trim().length === 0) el.style.display = 'none';
    });

});

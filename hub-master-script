// 1. Accessibility
window.toggleAccessibility = function() {
    document.body.classList.toggle('accessibility-mode');
    const btn = document.querySelector('.util-btn[onclick="toggleAccessibility()"]');
    if(btn) btn.classList.toggle('active');
};

// 2. Copy Link
window.copyToClipboard = function() {
    const dummy = document.createElement('input');
    document.body.appendChild(dummy);
    dummy.value = window.location.href;
    dummy.select();
    document.execCommand('copy');
    document.body.removeChild(dummy);
    const btn = document.querySelector('.share-trigger');
    btn.innerHTML = 'Copied <i class="fa-solid fa-check"></i>';
    setTimeout(() => { btn.innerHTML = 'Share <i class="fa-solid fa-share-from-square"></i>'; }, 2000);
};

// 3. FAQ Accordion
window.toggleFaq = function(header) {
    header.classList.toggle('active');
    var content = header.nextElementSibling;
    if (content.style.maxHeight) { content.style.maxHeight = null; } 
    else { content.style.maxHeight = content.scrollHeight + "px"; }
};

// 4. Update Time
function updateDateTime() {
    const now = new Date();
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
    
    const dateEl = document.getElementById('current-date');
    const timeEl = document.getElementById('current-time');

    if(dateEl) dateEl.textContent = now.toLocaleDateString('en-US', dateOptions);
    if(timeEl) timeEl.textContent = now.toLocaleTimeString('en-US', timeOptions);
}
updateDateTime();
setInterval(updateDateTime, 1000);

// 5. Market Tracker Selector
function updateTracker(url) {
    const iframe = document.getElementById('tracker-frame');
    if(iframe) iframe.src = url;
}

// 6. Feedback Logic
window.updateRatingDisplay = function(val) {
    document.getElementById('ratingValue').innerText = val + "/5";
};

window.submitFeedback = function(e) {
    e.preventDefault();
    
    const rating = document.getElementById('ratingSlider').value;
    const notes = document.getElementById('feedbackNotes').value;
    const pageUrl = window.location.href;
    const timestamp = new Date().toISOString();
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeHVZiDONjwbGlzgXSdTWYCNvZ0CiOhkV-9SAh2Jl5wzVxfA4rlb5RwYjSU8TUibzp/exec"; 
    
    const data = { timestamp: timestamp, url: pageUrl, rating: rating, feedback: notes };

    const submitBtn = e.target.querySelector('button');
    const originalText = submitBtn.innerText;
    submitBtn.innerText = "Sending...";
    submitBtn.disabled = true;

    if (GOOGLE_SCRIPT_URL) {
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(() => {
            document.getElementById('feedbackForm').style.display = 'none';
            document.getElementById('feedbackMessage').style.display = 'block';
        })
        .catch(err => {
            console.error('Error:', err);
            alert("Error sending feedback. Please try again.");
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
        });
    }
};

// 8. SPA ROUTING & SCROLL FIXES (Newsletter + Education Hub)

    // --- Helper: Universal Scroll-To-Top ---
    function snapToTop(elementId) {
        const el = document.getElementById(elementId);
        if (el) {
            // This forces the browser to snap the top of the element 
            // to the top of the viewport instantly.
            el.scrollIntoView({ behavior: 'instant', block: 'start' });
        } else {
            // Fallback for older browsers or missing IDs
            window.scrollTo(0, 0);
        }
    }

    // --- A. NEWSLETTER ARCHIVE LOGIC ---
    window.switchView = function(viewId) {
        // 1. Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('it-hidden'));
        
        // 2. Show target and Snap to Top
        const target = document.getElementById(viewId);
        if (target) {
            target.classList.remove('it-hidden');
            snapToTop(viewId);
        }

        // 3. Handle Nav Visibility
        if (viewId === 'view-archive') {
            const archNav = document.getElementById('archive-nav');
            const artNav = document.getElementById('article-nav');
            if(archNav) archNav.classList.remove('it-hidden');
            if(artNav) artNav.classList.add('it-hidden');
            
            // Update URL without hash for the main list
            history.pushState("", document.title, window.location.pathname + window.location.search);
        } else {
            const archNav = document.getElementById('archive-nav');
            const artNav = document.getElementById('article-nav');
            if(archNav) archNav.classList.add('it-hidden');
            if(artNav) artNav.classList.remove('it-hidden');
            
            // Set hash for deep linking
            window.location.hash = viewId;
        }
    };

    // --- B. EDUCATION HUB LOGIC (Overrides Local Script) ---
    // We redefine 'loadLesson' here to force the scroll fix.
    // This assumes 'courseData' is already defined on the page.
    window.loadLesson = function(id) {
        // Safety Check: Does courseData exist?
        if (typeof courseData === 'undefined' || !courseData[id]) return;
        
        const data = courseData[id];
        
        // 1. Populate Content
        const titleEl = document.getElementById('lesson-title');
        if(titleEl) titleEl.innerText = data.title;
        
        const diffEl = document.getElementById('lesson-difficulty');
        if(diffEl) diffEl.innerHTML = `<i class="fa-solid fa-signal"></i> ${data.difficulty}`;
        
        const durEl = document.getElementById('lesson-duration');
        if(durEl) durEl.innerHTML = `<i class="fa-regular fa-clock"></i> ${data.duration} Min`;

        const updateEl = document.getElementById('lesson-updated');
        if(updateEl) updateEl.innerHTML = `<i class="fa-regular fa-calendar"></i> ${data.updated}`;

        const videoEl = document.getElementById('lesson-video');
        if(videoEl) videoEl.src = data.video;

        const objEl = document.getElementById('lesson-objectives');
        if(objEl) objEl.innerHTML = data.objectives.map(o => `<li>${o}</li>`).join('');

        // 2. Render Accordions (Notes)
        const notesContainer = document.getElementById('lesson-notes');
        if (notesContainer) {
            notesContainer.innerHTML = '';
            data.notes.forEach((note) => {
                notesContainer.innerHTML += `
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="window.toggleAccordion(this)">
                            ${note.title} <i class="fa-solid fa-chevron-down accordion-icon"></i>
                        </div>
                        <div class="accordion-content"><div class="accordion-body">${note.content}</div></div>
                    </div>
                `;
            });
        }

        // 3. Render Tags & Extras
        const tagEl = document.getElementById('lesson-tags');
        if(tagEl) tagEl.innerHTML = data.tags.map(t => `<span class="tool-tag">${t}</span>`).join('');
        
        // (Simplified Related/Resource logic to prevent errors if elements missing)
        const relatedList = document.getElementById('lesson-related');
        const cardRelated = document.getElementById('card-related');
        if (relatedList && cardRelated) {
            if (data.related && data.related.length > 0) {
                cardRelated.style.display = 'block';
                relatedList.innerHTML = data.related.map(r => 
                    `<li><a onclick="openTraining('${r.linkId}')" style="cursor:pointer"><i class="fa-solid ${r.icon}"></i> ${r.title}</a></li>`
                ).join('');
            } else {
                cardRelated.style.display = 'none';
            }
        }
        
        const resourcesList = document.getElementById('lesson-resources');
        const cardResources = document.getElementById('card-resources');
        if (resourcesList && cardResources) {
            if (data.resources && data.resources.length > 0) {
                cardResources.style.display = 'block';
                resourcesList.innerHTML = data.resources.map(r => 
                    `<li><a href="${r.url}" target="_blank"><i class="fa-solid ${r.icon}"></i> ${r.title}</a></li>`
                ).join('');
            } else {
                cardResources.style.display = 'none';
            }
        }

        // 4. Reset Quiz
        if (typeof resetQuizUI === 'function') resetQuizUI();
        const fbForm = document.getElementById('feedbackForm');
        if(fbForm) {
            fbForm.reset();
            fbForm.style.display = 'block';
        }
        const fbMsg = document.getElementById('feedbackMessage');
        if(fbMsg) fbMsg.style.display = 'none';

        // 5. SWITCH VIEW & SNAP TO TOP
        const landing = document.getElementById('view-landing');
        const lesson = document.getElementById('view-lesson-template');
        const landingNav = document.getElementById('landing-nav');
        const lessonNav = document.getElementById('lesson-nav');

        if(landing) landing.classList.add('it-hidden');
        if(lesson) {
            lesson.classList.remove('it-hidden');
            // THE FIX:
            snapToTop('view-lesson-template');
        }
        
        if(landingNav) landingNav.classList.add('it-hidden');
        if(lessonNav) lessonNav.classList.remove('it-hidden');
    };

    // --- C. EDUCATION HUB ENTRY POINT (Overrides Local Script) ---
    window.openTraining = function(viewId) {
        if (viewId === 'view-landing') {
            // Switch to Landing
            history.pushState("", document.title, window.location.pathname + window.location.search);
            
            const landing = document.getElementById('view-landing');
            const lesson = document.getElementById('view-lesson-template');
            const landingNav = document.getElementById('landing-nav');
            const lessonNav = document.getElementById('lesson-nav');

            if(lesson) lesson.classList.add('it-hidden');
            if(landing) {
                landing.classList.remove('it-hidden');
                snapToTop('view-landing'); // Snap landing to top too!
            }
            if(landingNav) landingNav.classList.remove('it-hidden');
            if(lessonNav) lessonNav.classList.add('it-hidden');

        } else {
            // Switch to Lesson
            // We use the global 'courseData' variable defined in your local HTML
            if (typeof courseData !== 'undefined' && courseData[viewId]) {
                window.location.hash = viewId;
                window.loadLesson(viewId);
            }
        }
    };

// 9. PERSISTENT HASH POLLING (The Fix for Hydration Errors)
var pollCount = 0;
var hashCheck = setInterval(function() {
    pollCount++;
    if (window.location.hash) {
    var targetId = window.location.hash.substring(1);
    var targetElement = document.getElementById(targetId);
    if (targetElement) {
        if (targetElement.classList.contains('it-hidden')) {
        window.switchView(targetId);
        }
    }
    }
    if (pollCount > 20) clearInterval(hashCheck);
}, 100);

// 10. Filter/Sort Logic
function filterNews() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const topic = document.getElementById('filter-topic').value;
    const items = document.querySelectorAll('.news-item');
    items.forEach(item => {
    const text = item.innerText.toLowerCase();
    const tags = item.getAttribute('data-tags').toLowerCase();
    const matchSearch = text.includes(search);
    const matchTopic = (topic === 'All') || tags.includes(topic.toLowerCase());
    if (matchSearch && matchTopic) {
        item.style.display = 'flex';
    } else {
        item.style.display = 'none';
    }
    });
}

function sortNews() {
    const order = document.getElementById('sort-order').value;
    // Changed from 'grid-container' to 'news-container' to handle the unified grid
    const grid = document.getElementById('news-container');
    const items = Array.from(grid.children);
    items.sort((a, b) => {
    const dateA = new Date(a.getAttribute('data-date'));
    const dateB = new Date(b.getAttribute('data-date'));
    return (order === 'newest') ? dateB - dateA : dateA - dateB;
    });
    items.forEach(item => grid.appendChild(item));
}

// 11. Interest Capture Logic
window.captureInterest = function(btnElement, deliverableName) {
    // Disable button immediately
    const originalText = btnElement.innerHTML;
    btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
    btnElement.disabled = true;

    // 1. Gather Data (Assuming email is available in global scope or unknown)
    const userEmail = window.analyticsUserEmail || "unknown@user.com"; 
    const timestamp = new Date().toISOString();

    const payload = {
        email: userEmail,
        domain: window.location.hostname,
        path: window.location.pathname,
        date: timestamp,
        deliverable: deliverableName
    };

    // 2. Send to Google Sheets (Replace URL)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3QwMuUpiPeRKEtV_wi2RvMGWTqffS8qe6M0iI7VbiXUrnn5pPez-QTIbexztbKsbR/exec"; 

    fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors", 
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(() => {
        btnElement.classList.add('sent');
        btnElement.innerHTML = '<i class="fa-solid fa-check"></i> Request Sent';
    })
    .catch(error => {
        console.error("Error logging interest:", error);
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
        alert("There was a slight issue sending your request. Please contact your account manager.");
    });
};

//Education Hub Lesson Page 

let currentScore = 0;
let quizHistory = [];
let currentQuestionIndex = 0;
let totalQuestions = 0;

// 2. INITIALIZATION LOGIC FOR SPAs
function initTrainingPage() {
    const questions = document.querySelectorAll('.quiz-question-step');
    if(questions.length > 0) {
        totalQuestions = questions.length;
        const totalEl = document.getElementById('total-questions');
        if(totalEl) totalEl.innerText = totalQuestions;
        
        // Ensure intro is active
        const intro = document.getElementById('quiz-intro');
        if(intro) intro.classList.add('active');
    }
}

if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initTrainingPage();
} else {
    document.addEventListener('DOMContentLoaded', initTrainingPage);
}

// 3. EXPOSE FUNCTIONS
window.startQuiz = function() {
    document.getElementById('quiz-intro').classList.remove('active');
    document.getElementById('quiz-q-0').classList.add('active');
    
    currentScore = 0;
    currentQuestionIndex = 0;
    quizHistory = [];
    
    updateProgressBar();
    document.getElementById('quiz-progress').style.display = 'flex';
};

window.handleAnswerClick = function(btn) {
    const isCorrect = btn.getAttribute('data-correct') === 'true';
    const parentStep = btn.closest('.quiz-step');
    const feedbackEl = parentStep.querySelector('.quiz-feedback');
    const questionText = parentStep.querySelector('.q-text').innerText;
    
    // Find correct answer text
    let correctAnswerText = "Unknown";
    const buttons = parentStep.querySelectorAll('.quiz-option-btn');
    buttons.forEach(b => {
        if(b.getAttribute('data-correct') === 'true') correctAnswerText = b.innerText;
    });

    // UI Updates
    if (isCorrect) {
        btn.classList.add('correct');
        feedbackEl.innerHTML = '<span style="color:#2ECC71"><i class="fa-solid fa-check"></i> Correct!</span>';
        currentScore++;
    } else {
        btn.classList.add('incorrect');
        feedbackEl.innerHTML = '<span style="color:#E74C3C"><i class="fa-solid fa-xmark"></i> Incorrect.</span>';
    }

    // Lock buttons
    buttons.forEach(b => {
        b.disabled = true;
        if (b.getAttribute('data-correct') === 'true') b.classList.add('correct');
        else if (!b.classList.contains('incorrect')) {
            b.style.opacity = "0.5"; b.style.filter = "grayscale(1)";
        }
    });

    // Save History
    quizHistory.push({
        q: questionText,
        userAns: btn.innerText,
        correct: isCorrect,
        correctAns: correctAnswerText
    });

    // Move to next
    setTimeout(() => {
        parentStep.classList.remove('active');
        currentQuestionIndex++;
        
        const nextStep = document.getElementById(`quiz-q-${currentQuestionIndex}`);
        if (nextStep) {
            nextStep.classList.add('active');
            updateProgressBar();
        } else {
            showResults();
        }
    }, 1500);
};

function updateProgressBar() {
    const bar = document.getElementById('progress-bar-fill');
    const text = document.getElementById('progress-text');
    if(text) text.innerText = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
    if(bar) bar.style.width = ((currentQuestionIndex + 1) / totalQuestions * 100) + '%';
}

function showResults() {
    document.getElementById('quiz-progress').style.display = 'none';
    document.getElementById('quiz-results').classList.add('active');
    document.getElementById('final-score').innerText = currentScore;
    
    // Render Review
    const container = document.getElementById('quiz-review-container');
    container.innerHTML = '';
    
    quizHistory.forEach((h, i) => {
        const icon = h.correct ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-xmark"></i>';
        const cls = h.correct ? '' : 'wrong';
        const correctText = h.correct ? '' : `<div style="font-size:12px; color:#555; margin-top:4px;">Correct: ${h.correctAns}</div>`;
        
        container.innerHTML += `
            <div class="review-item">
                <div class="review-q">${i+1}. ${h.q}</div>
                <div class="review-a ${cls}">${icon} Your Answer: ${h.userAns}</div>
                ${correctText}
            </div>
        `;
    });

    // Celebration
    if (currentScore === totalQuestions) {
        if (typeof confetti === 'function') {
            const rect = document.getElementById('quiz-section').getBoundingClientRect();
            const x = (rect.left + rect.width/2) / window.innerWidth;
            confetti({ particleCount: 150, spread: 70, origin: { x: x, y: 0.6 }, colors: ['#084A87', '#E67E22', '#2ECC71'] });
        }
        setTimeout(() => {
            document.getElementById('certificate-modal').style.setProperty('display', 'flex', 'important');
        }, 800);
    }
}

// --- LOCAL ACCORDION ---
window.toggleLocalAccordion = function(header) {
    header.classList.toggle('active');
    var content = header.nextElementSibling;
    if (content.style.maxHeight) {
        content.style.maxHeight = null;
        content.classList.remove('open');
    } else {
        content.classList.add('open');
        content.style.maxHeight = content.scrollHeight + "px";
    }
};

// =================================================================
// PLATINUM GLOBAL REFRESH (Polished Version)
// =================================================================

(function() {
    document.addEventListener('click', function(e) {
        const target = e.target;
        const button = target.closest('button');

        // --- 1. DROPDOWN PROTECTION (Arrow Check) ---
        if (button) {
            const iconWrapper = target.closest('div');
            if (iconWrapper && iconWrapper.parentElement === button) {
                return; // Let menu expand
            }
        }

        const link = target.closest('a');

        // --- Safety Checks ---
        if (!link || !link.href) return; 
        if (link.getAttribute('href').startsWith('#') || 
            link.getAttribute('href').startsWith('javascript')) return;
        if (e.metaKey || e.ctrlKey || e.shiftKey) return;

        // --- 2. ANCHOR LINK POLISH ---
        if (link.pathname === window.location.pathname && link.hash) {
            return; // It's just a jump on the current page. Let it happen.
        }

        // --- 3. GLOBAL FORCE REFRESH ---
        if (link.origin === window.location.origin) {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = link.href;
        }

    }, true); 
})();

window.closeCert = function() {
    document.getElementById('certificate-modal').style.setProperty('display', 'none', 'important');
};

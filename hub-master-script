// 1. Accessibility
    window.toggleAccessibility = function() {
        document.body.classList.toggle('accessibility-mode');
        const btn = document.querySelector('.util-btn[onclick="toggleAccessibility()"]');
        if(btn) btn.classList.toggle('active');
    };

    // 2. Copy Link
    window.copyToClipboard = function() {
        const dummy = document.createElement('input');
        document.body.appendChild(dummy);
        dummy.value = window.location.href;
        dummy.select();
        document.execCommand('copy');
        document.body.removeChild(dummy);
        const btn = document.querySelector('.share-trigger');
        btn.innerHTML = 'Copied <i class="fa-solid fa-check"></i>';
        setTimeout(() => { btn.innerHTML = 'Share <i class="fa-solid fa-share-from-square"></i>'; }, 2000);
    };

    // 3. FAQ Accordion
    window.toggleFaq = function(header) {
        header.classList.toggle('active');
        var content = header.nextElementSibling;
        if (content.style.maxHeight) { content.style.maxHeight = null; } 
        else { content.style.maxHeight = content.scrollHeight + "px"; }
    };

    // 4. Update Time
    function updateDateTime() {
        const now = new Date();
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
        
        const dateEl = document.getElementById('current-date');
        const timeEl = document.getElementById('current-time');

        if(dateEl) dateEl.textContent = now.toLocaleDateString('en-US', dateOptions);
        if(timeEl) timeEl.textContent = now.toLocaleTimeString('en-US', timeOptions);
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // 5. Market Tracker Selector
    function updateTracker(url) {
        const iframe = document.getElementById('tracker-frame');
        if(iframe) iframe.src = url;
    }

     // 6. Feedback Logic
    window.updateRatingDisplay = function(val) {
        document.getElementById('ratingValue').innerText = val + "/5";
    };

    window.submitFeedback = function(e) {
        e.preventDefault();
        
        const rating = document.getElementById('ratingSlider').value;
        const notes = document.getElementById('feedbackNotes').value;
        const pageUrl = window.location.href;
        const timestamp = new Date().toISOString();
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxeHVZiDONjwbGlzgXSdTWYCNvZ0CiOhkV-9SAh2Jl5wzVxfA4rlb5RwYjSU8TUibzp/exec"; 
        
        const data = { timestamp: timestamp, url: pageUrl, rating: rating, feedback: notes };

        const submitBtn = e.target.querySelector('button');
        const originalText = submitBtn.innerText;
        submitBtn.innerText = "Sending...";
        submitBtn.disabled = true;

        if (GOOGLE_SCRIPT_URL) {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                document.getElementById('feedbackForm').style.display = 'none';
                document.getElementById('feedbackMessage').style.display = 'block';
            })
            .catch(err => {
                console.error('Error:', err);
                alert("Error sending feedback. Please try again.");
                submitBtn.innerText = originalText;
                submitBtn.disabled = false;
            });
        }
    };

    // 7. Hash Copy Logic
    window.copyToClipboard = function() {
      const dummy = document.createElement('input');
      document.body.appendChild(dummy);
      dummy.value = window.location.href; // Copies current hash
      dummy.select();
      document.execCommand('copy');
      document.body.removeChild(dummy);
      const btn = document.querySelector('.share-trigger');
      btn.innerHTML = 'Copied <i class="fa-solid fa-check"></i>';
      setTimeout(() => {
        btn.innerHTML = 'Share <i class="fa-solid fa-share-from-square"></i>';
      }, 2000);
    };

    // 8. SPA Switcher & Hash Routing
    window.switchView = function(viewId) {
      // Hide all views
      document.querySelectorAll('.view-section').forEach(el => el.classList.add('it-hidden'));
      document.getElementById(viewId).classList.remove('it-hidden');
      // Handle Nav Visibility
      if (viewId === 'view-archive') {
        // SHOW Pills, HIDE Back Button
        document.getElementById('archive-nav').classList.remove('it-hidden');
        document.getElementById('article-nav').classList.add('it-hidden');
        history.pushState("", document.title, window.location.pathname + window.location.search);
      } else {
        // HIDE Pills, SHOW Back Button
        document.getElementById('archive-nav').classList.add('it-hidden');
        document.getElementById('article-nav').classList.remove('it-hidden');
        window.location.hash = viewId;
      }
      window.scrollTo(0, 0);
    };

    // 9. PERSISTENT HASH POLLING (The Fix for Hydration Errors)
    var pollCount = 0;
    var hashCheck = setInterval(function() {
      pollCount++;
      if (window.location.hash) {
        var targetId = window.location.hash.substring(1);
        var targetElement = document.getElementById(targetId);
        if (targetElement) {
          if (targetElement.classList.contains('it-hidden')) {
            window.switchView(targetId);
          }
        }
      }
      if (pollCount > 20) clearInterval(hashCheck);
    }, 100);

    // 10. Filter/Sort Logic
    function filterNews() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const topic = document.getElementById('filter-topic').value;
      const items = document.querySelectorAll('.news-item');
      items.forEach(item => {
        const text = item.innerText.toLowerCase();
        const tags = item.getAttribute('data-tags').toLowerCase();
        const matchSearch = text.includes(search);
        const matchTopic = (topic === 'All') || tags.includes(topic.toLowerCase());
        if (matchSearch && matchTopic) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function sortNews() {
      const order = document.getElementById('sort-order').value;
      // Changed from 'grid-container' to 'news-container' to handle the unified grid
      const grid = document.getElementById('news-container');
      const items = Array.from(grid.children);
      items.sort((a, b) => {
        const dateA = new Date(a.getAttribute('data-date'));
        const dateB = new Date(b.getAttribute('data-date'));
        return (order === 'newest') ? dateB - dateA : dateA - dateB;
      });
      items.forEach(item => grid.appendChild(item));
    }

     // 11. Interest Capture Logic
    window.captureInterest = function(btnElement, deliverableName) {
        // Disable button immediately
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
        btnElement.disabled = true;

        // 1. Gather Data (Assuming email is available in global scope or unknown)
        const userEmail = window.analyticsUserEmail || "unknown@user.com"; 
        const timestamp = new Date().toISOString();

        const payload = {
            email: userEmail,
            domain: window.location.hostname,
            path: window.location.pathname,
            date: timestamp,
            deliverable: deliverableName
        };

        // 2. Send to Google Sheets (Replace URL)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3QwMuUpiPeRKEtV_wi2RvMGWTqffS8qe6M0iI7VbiXUrnn5pPez-QTIbexztbKsbR/exec"; 

        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(() => {
            btnElement.classList.add('sent');
            btnElement.innerHTML = '<i class="fa-solid fa-check"></i> Request Sent';
        })
        .catch(error => {
            console.error("Error logging interest:", error);
            btnElement.innerHTML = originalText;
            btnElement.disabled = false;
            alert("There was a slight issue sending your request. Please contact your account manager.");
        });
    };








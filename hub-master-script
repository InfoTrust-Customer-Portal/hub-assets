/**
 * INFOTRUST PORTAL MASTER SCRIPT - V3.1 (STABLE)
 */

// 1. GLOBAL UTILITIES
window.toggleAccessibility = function() {
    document.body.classList.toggle('accessibility-mode');
};
window.copyToClipboard = function() {
    const dummy = document.createElement('input');
    document.body.appendChild(dummy);
    dummy.value = window.location.href;
    dummy.select();
    document.execCommand('copy');
    document.body.removeChild(dummy);
    const shareBtns = document.querySelectorAll('.share-trigger');
    shareBtns.forEach(btn => {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = 'Copied <i class="fa-solid fa-check"></i>';
        setTimeout(() => { btn.innerHTML = originalHTML; }, 2000);
    });
};

// 2. THE MASTER NAVIGATOR
// This is what makes your cards and back buttons work across different pages.
window.switchView = function(viewId) {
    const target = document.getElementById(viewId);
    if (!target) return;

    // Universal Hide
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('it-hidden'));
    target.classList.remove('it-hidden');

    // ROUTE A: It's an Education Hub Lesson
    if (typeof courseData !== 'undefined' && courseData[viewId]) {
        window.location.hash = viewId;
        loadLesson(viewId); 
    } 
    // ROUTE B: It's a Newsletter Update or Archive
    else if (viewId === 'view-archive' || viewId.startsWith('view-20') || viewId.startsWith('view-nov') || viewId.startsWith('view-oct')) {
        const archNav = document.getElementById('archive-nav');
        const artNav = document.getElementById('article-nav');
        
        if (viewId === 'view-archive') {
            if (archNav) archNav.classList.remove('it-hidden');
            if (artNav) artNav.classList.add('it-hidden');
            history.pushState("", document.title, window.location.pathname + window.location.search);
        } else {
            if (archNav) archNav.classList.add('it-hidden');
            if (artNav) artNav.classList.remove('it-hidden');
            window.location.hash = viewId;
        }
    }
    // ROUTE C: Standard Page
    else {
        window.location.hash = viewId;
    }
    window.scrollTo(0,0);
};

// 3. EDUCATION HUB ENGINE (Namespaced)
let edu_quizHistory = [];
let edu_currentScore = 0;
let edu_currentCourseId = null;

window.loadLesson = function(id) {
    const data = courseData[id];
    if (!data) return;
    
    edu_currentCourseId = id;
    edu_currentScore = 0;
    edu_quizHistory = [];

    // Map content to HTML IDs
    const titleEl = document.getElementById('lesson-title');
    if(titleEl) titleEl.innerText = data.title;
    
    const videoEl = document.getElementById('lesson-video');
    if(videoEl) videoEl.src = data.video;
    
    const notesEl = document.getElementById('lesson-notes');
    if (notesEl) {
        notesEl.innerHTML = data.notes.map(n => `
            <div class="accordion-item">
                <div class="accordion-header" onclick="window.toggleAccordion(this)">
                    ${n.title} <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="accordion-content"><div class="accordion-body">${n.content}</div></div>
            </div>`).join('');
    }

    const objectivesEl = document.getElementById('lesson-objectives');
    if(objectivesEl) objectivesEl.innerHTML = data.objectives.map(o => `<li>${o}</li>`).join('');
    
    resetQuizUI();
    
    // Toggle Hub Navs
    const landNav = document.getElementById('landing-nav');
    const lessNav = document.getElementById('lesson-nav');
    if (landNav) landNav.classList.add('it-hidden');
    if (lessNav) lessNav.classList.remove('it-hidden');
};

// 4. QUIZ LOGIC
function resetQuizUI() {
    const data = courseData[edu_currentCourseId];
    const quizSection = document.getElementById('quiz-section');
    if(!data || !data.quiz) { if(quizSection) quizSection.style.display = 'none'; return; }
    
    if(quizSection) quizSection.style.display = 'flex';
    const container = document.getElementById('dynamic-quiz-content');
    if(container) {
        container.innerHTML = data.quiz.map((q, idx) => `
            <div id="q-${idx}" class="quiz-step">
                <div class="quiz-question-text"><span>${idx + 1}.</span> <span>${q.q}</span></div>
                <div class="quiz-options">${q.options.map((opt, oIdx) => `<button class="quiz-option-btn" onclick="checkAnswer(this, ${oIdx === q.correct}, ${idx})">${opt}</button>`).join('')}</div>
                <div class="quiz-feedback" id="feedback-${idx}"></div>
            </div>`).join('');
    }
    
    const intro = document.getElementById('quiz-intro');
    const results = document.getElementById('quiz-results');
    if(intro) intro.classList.add('active');
    if(results) results.classList.remove('active');
}

window.startQuiz = function() {
    const intro = document.getElementById('quiz-intro');
    const firstQ = document.getElementById('q-0');
    if(intro) intro.classList.remove('active');
    if(firstQ) firstQ.classList.add('active');
};

window.checkAnswer = function(btn, isCorrect, qIdx) {
    const data = courseData[edu_currentCourseId];
    const feedback = document.getElementById(`feedback-${qIdx}`);
    if(isCorrect) {
        btn.classList.add('correct');
        if(feedback) feedback.innerHTML = '<span style="color:#2ECC71">Correct!</span>';
        edu_currentScore++;
    } else {
        btn.classList.add('incorrect');
        if(feedback) feedback.innerHTML = '<span style="color:#E74C3C">Incorrect.</span>';
    }
    btn.parentElement.querySelectorAll('.quiz-option-btn').forEach(b => b.disabled = true);
    setTimeout(() => {
        document.getElementById(`q-${qIdx}`).classList.remove('active');
        if (qIdx + 1 < data.quiz.length) {
            document.getElementById(`q-${qIdx + 1}`).classList.add('active');
        } else {
            showResults();
        }
    }, 1200);
};

function showResults() {
    const results = document.getElementById('quiz-results');
    if(results) results.classList.add('active');
    const scoreEl = document.getElementById('final-score');
    if(scoreEl) scoreEl.innerText = edu_currentScore;

    if (edu_currentScore === courseData[edu_currentCourseId].quiz.length) {
        if(typeof confetti === 'function') confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        const modal = document.getElementById('certificate-modal');
        if(modal) modal.style.setProperty('display', 'flex', 'important');
    }
}

window.closeCert = function() {
    const modal = document.getElementById('certificate-modal');
    if(modal) modal.style.setProperty('display', 'none', 'important');
};

// 5. SHARED UI & NEWSLETTER LOGIC
window.toggleAccordion = function(header) {
    header.classList.toggle('active');
    const content = header.nextElementSibling;
    if (content) content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
};

// Start Clock & Routing on Load
document.addEventListener("DOMContentLoaded", function() {
    if(window.location.hash) {
        const targetId = window.location.hash.substring(1);
        if (typeof courseData !== 'undefined' && courseData[targetId]) {
            loadLesson(targetId);
        } else if (document.getElementById(targetId)) {
            window.switchView(targetId);
        }
    }
});
